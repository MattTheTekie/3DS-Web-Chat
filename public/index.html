<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIM XP 3DS</title>

<style>
body {
  margin: 0;
  background: #3A6EA5;
  font-family: Tahoma;
  font-size: 14px;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

#window {
  width: 100%;
  max-width: 900px;
  height: 100%;
  max-height: 600px;
  background: #ECE9D8;
  border: 2px solid #0A246A;
  display: flex;
  flex-direction: column;
}

@media (max-width: 600px) {
  #window {
    height: 100vh;
    width: 100vw;
    border: none;
  }

  #main {
    flex-direction: column;
  }

  #chat {
    height: 200px;
  }
}

#titlebar {
  height: 30px;
  background: #0A246A;
  color: white;
  line-height: 30px;
  padding-left: 10px;
  font-weight: bold;
}

#main {
  flex: 1;
  display: flex;
  padding: 6px;
  gap: 6px;
  overflow: hidden;
}

#chatArea {
  flex: 3;
  display: flex;
  flex-direction: column;
  padding: 5px;
  overflow: hidden;
}

#chat {
  flex: 1;
  background: white;
  border: 2px inset gray;
  overflow-y: scroll;
  padding: 5px;
}

#inputArea {
  margin-top: 6px;
}

#inputArea input[type="text"] {
  width: 70%;
}

#usersPanel {
  flex: 1;
  background: #F4F4F4;
  border: 2px inset gray;
  padding: 6px;
  overflow-y: auto;
  min-width: 180px;
  font-size: 12px;
}

input, button {
  font-family: Tahoma;
  font-size: 14px;
}

button {
  border: 2px outset gray;
  background: #ECE9D8;
  cursor: pointer;
}

button:active {
  border: 2px inset gray;
}

#users {
  margin-top: 5px;
}

/* Hide the mirrored fields */
.hiddenField {
  display: none;
}
</style>
</head>
<body>

<div id="window">
  <div id="titlebar">AIM - <span id="roomTitle">Lobby</span></div>

  <div id="main">

    <!-- CHAT AREA -->
    <div id="chatArea">
      <div id="chat"></div>

      <div id="inputArea">
        Name: <input type="text" id="username" size="10"><br><br>

        <input type="text" id="message" placeholder="Type message...">
        <button onclick="sendMessage()">Send</button>

        <br><br>

        <!-- 3DS-compatible upload form -->
        <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
          <!-- Hidden mirrored fields -->
          <input type="text" name="room" id="uploadRoom" class="hiddenField" required>
          <input type="text" name="user" id="uploadUser" class="hiddenField" required>
          
          <input type="file" name="image" required><br>
          <button type="submit">Upload</button>
        </form>
      </div>
    </div>

    <!-- USERS PANEL -->
    <div id="usersPanel">
      <b>Room</b><br>
      <input type="text" id="roomInput" size="10"><br>
      <button onclick="createRoom()">Create</button>
      <button onclick="joinRoom(document.getElementById('roomInput').value)">Join</button>

      <hr>

      <b>Users</b>
      <div id="users"></div>
    </div>

  </div>
</div>

<script>
var currentRoom="Lobby";
var lastCount=0;

/* ---------- AJAX helper ---------- */
function xhrPost(url,data){
  var xhr=new XMLHttpRequest();
  xhr.open("POST",url,true);
  xhr.setRequestHeader("Content-Type","application/json");
  xhr.send(JSON.stringify(data));
}

/* ---------- Room Management ---------- */
function createRoom(){
  var name=document.getElementById("roomInput").value.trim();
  if(!name) return;
  xhrPost("/create-room",{name:name});
}

function joinRoom(name){
  var user=document.getElementById("username").value.trim();
  if(!name||!user) return;

  currentRoom=name;
  document.getElementById("roomTitle").innerHTML=name;
  lastCount=0;
}

/* ---------- Send Message ---------- */
function sendMessage(){
  var text=document.getElementById("message").value.trim();
  var user=document.getElementById("username").value.trim();
  if(!text||!user) return;

  xhrPost("/send",{room:currentRoom,user:user,text:text});
  document.getElementById("message").value="";
}

/* ENTER KEY SEND */
document.getElementById("message").addEventListener("keydown", function(e){
  if(e.key==="Enter"){
    e.preventDefault();
    sendMessage();
  }
});

/* ---------- Poll Messages ---------- */
function poll(){
  var xhr=new XMLHttpRequest();
  xhr.open("GET","/messages?room="+currentRoom,true);
  xhr.onload=function(){
    var msgs=JSON.parse(xhr.responseText);
    if(msgs.length!=lastCount){
      var chat=document.getElementById("chat");
      var usersBox=document.getElementById("users");
      chat.innerHTML="";
      var users={};

      for(var i=0;i<msgs.length;i++){
        var m=msgs[i];
        if(m.system){
          chat.innerHTML+="<div style='color:gray'>"+m.text+"</div>";
        } else {
          users[m.user]=true;
          chat.innerHTML+="<div><b style='color:#000080'>"+m.user+":</b> "+m.text+"</div>";
        }
      }

      usersBox.innerHTML="";
      for(var u in users){
        usersBox.innerHTML+=u+"<br>";
      }

      chat.scrollTop=chat.scrollHeight;
      lastCount=msgs.length;
    }
  };
  xhr.send();
}

/* ---------- Leave Handling ---------- */
function sendLeave(){
  var user=document.getElementById("username").value;
  if(user&&currentRoom){
    navigator.sendBeacon("/leave", JSON.stringify({room:currentRoom,user:user}));
  }
}

window.addEventListener("beforeunload", sendLeave);
window.addEventListener("pagehide", sendLeave);

/* ---------- Mirror username & room to hidden fields ---------- */
function syncHiddenFields() {
  var username = document.getElementById("username").value;
  var room = document.getElementById("roomInput").value || currentRoom;

  document.getElementById("uploadUser").value = username;
  document.getElementById("uploadRoom").value = room;
}

// Sync on input changes
document.getElementById("username").addEventListener("input", syncHiddenFields);
document.getElementById("roomInput").addEventListener("input", syncHiddenFields);

// Also sync periodically in case room changes programmatically
setInterval(syncHiddenFields, 500);

/* ---------- Start Polling ---------- */
xhrPost("/create-room",{name:"Lobby"});
setInterval(poll,1500);
</script>

</body>
</html>
